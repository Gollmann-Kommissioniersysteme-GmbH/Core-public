name: Wiki Change to Discussion

on:
  gollum  # Triggers when the wiki is updated

jobs:
  post-discussion:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Repo Information
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO_NAME="$(basename ${{ github.repository }})"
          echo "Repository: $OWNER/$REPO_NAME"

      - name: Checkout Wiki Repo
        run: |
          git clone --depth=2 https://github.com/${{ github.repository }}.wiki.git wiki
          cd wiki
          LAST_COMMIT_SHA=$(git rev-parse HEAD)
          PREV_COMMIT_SHA=$(git rev-parse HEAD~1)

          echo "Last Commit: $LAST_COMMIT_SHA"
          echo "Previous Commit: $PREV_COMMIT_SHA"

          # Generate the changes (diff summary)
          CHANGES=$(git log -1 --pretty=format:"%s%n%n%b" $LAST_COMMIT_SHA)
          FILE_CHANGES=$(git diff --name-status $PREV_COMMIT_SHA $LAST_COMMIT_SHA)

          echo "Changes: $CHANGES"
          echo "File Changes: $FILE_CHANGES"

          # Store changes for later steps
          echo "CHANGES<<EOF" >> $GITHUB_ENV
          echo "$CHANGES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "FILE_CHANGES<<EOF" >> $GITHUB_ENV
          echo "$FILE_CHANGES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Discussion
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO_NAME="$(basename ${{ github.repository }})"
          ACTOR="${{ github.actor }}"
          WIKI_URL="https://github.com/$OWNER/$REPO_NAME/wiki"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # âœ… Fetch Correct Repository Global ID
          REPO_ID=$(gh api graphql -f query='
            query {
              repository(owner: "'"$OWNER"'", name: "'"$REPO_NAME"'") {
                id
              }
            }' | jq -r '.data.repository.id')

          if [[ -z "$REPO_ID" || "$REPO_ID" == "null" ]]; then
            echo "Error: Failed to retrieve repository global ID!"
            exit 1
          fi

          # âœ… Get Discussion Category ID (Default: General)
          CATEGORY_ID=$(gh api graphql -f query='
            query {
              repository(owner: "'"$OWNER"'", name: "'"$REPO_NAME"'") {
                discussionCategories(first: 10) {
                  nodes { id, name }
                }
              }
            }' | jq -r '.data.repository.discussionCategories.nodes[] | select(.name=="General") | .id')

          if [[ -z "$CATEGORY_ID" || "$CATEGORY_ID" == "null" ]]; then
            echo "Error: No valid discussion category found!"
            exit 1
          fi

          # âœ… Create Discussion with Wiki Changes
          DISCUSSION_TITLE="Wiki Updated by $ACTOR"
          DISCUSSION_BODY="ðŸ“– **Wiki Page Updated**  
          - **User:** $ACTOR  
          - **Time:** $TIMESTAMP  
          - **[View Wiki]($WIKI_URL)**  

          ### ðŸ”„ Changes:  
          \`\`\`
          $CHANGES
          \`\`\`

          ### ðŸ“„ Files Changed:  
          \`\`\`
          $FILE_CHANGES
          \`\`\`

          _This discussion was automatically created by GitHub Actions._"

          DISCUSSION_URL=$(gh api graphql -f query='
            mutation($repositoryId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {repositoryId: $repositoryId, categoryId: $categoryId, title: $title, body: $body}) {
                discussion {
                  url
                }
              }
            }' -F repositoryId="$REPO_ID" -F categoryId="$CATEGORY_ID" -F title="$DISCUSSION_TITLE" -F body="$DISCUSSION_BODY" | jq -r '.data.createDiscussion.discussion.url')

          if [[ -z "$DISCUSSION_URL" || "$DISCUSSION_URL" == "null" ]]; then
            echo "Error: Failed to create discussion!"
            exit 1
          fi

          echo "Discussion created: $DISCUSSION_URL"
